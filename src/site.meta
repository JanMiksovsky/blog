# Add slugs to the posts.
slugs = postSlugs(../posts):

# Convert posts from markdown to HTML.
html = mapDeep(slugs, mdHtml, extension='mdâ†’html'):

# Apply the post page template to the posts.
# This is used in the posts archive.
pages = mapDeep(html, postPage.ori):

# Add an index page to the year folders in the virtual pages graph.
years = map(pages, =mix(@value, setScope(this)), keyName='year'):
  index.html = year.ori(html(year)):

# The recent feed is the posts in reverse chronological order.
# For the `recent` feed, we only want 10 posts.
reversed = reverse(html):
recent = takeDeep(reverse(html), 10):

# The feed data is the recent posts with just the necessary feed data.
feedItems.yaml = map(valuesDeep(recent), feedItem):

# Main site
site = mix(public, this):
  # Add an index page to the overall posts archive.
  posts = mix(years, this):
    index.html = yearIndex.ori():

  # Top-level index page
  index.html = index.ori():

  feed.json = graph(feed.meta):
  rss.xml = feedRss(feed.json):
